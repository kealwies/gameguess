<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Ultimate Guessing Game</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        h1, h2, h3 {
            font-family: 'Orbitron', sans-serif;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #0a0a0a;
            border-radius: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #dc2626;
            border-radius: 8px;
            border: 2px solid #b91c1c;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #ef4444;
        }

        /* Background Grid Glow Animation (Red/Dark theme) */
        @keyframes bg-grid-glow-red {
            0% { background-position: 0% 0%; filter: hue-rotate(0deg); }
            100% { background-position: 200% 200%; filter: hue-rotate(360deg); }
        }
        .animate-bg-grid-glow-red {
            background-image: linear-gradient(rgba(220, 38, 38, 0.05) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(220, 38, 38, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            animation: bg-grid-glow-red 100s linear infinite;
        }

        /* Background Grid Glow Animation (Blue/Dark theme) */
        @keyframes bg-grid-glow-blue {
            0% { background-position: 0% 0%; filter: hue-rotate(0deg); }
            100% { background-position: 200% 200%; filter: hue-rotate(360deg); }
        }
        .animate-bg-grid-glow-blue {
            background-image: linear-gradient(rgba(59, 130, 246, 0.05) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(59, 130, 246, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            animation: bg-grid-glow-blue 100s linear infinite;
        }

        /* Text Neon Glitch Glow */
        @keyframes text-glitch-glow {
            0%, 100% { text-shadow: 0 0 6px #fff, 0 0 12px #fff, 0 0 20px #f00, 0 0 28px #f00, 0 0 36px #f00; transform: translate(0,0); opacity: 1; }
            10% { text-shadow: 0 0 6px #fff, 0 0 12px #fff, 0 0 20px #ff00ff, 0 0 28px #ff00ff, 0 0 36px #ff00ff; transform: translate(-2px, 2px); opacity: 0.9; }
            20% { text-shadow: 0 0 6px #fff, 0 0 12px #fff, 0 0 20px #f00, 0 0 28px #f00, 0 0 36px #f00; transform: translate(2px, -2px); opacity: 1; }
            30% { text-shadow: 0 0 6px #fff, 0 0 12px #fff, 0 0 20px #00ffff, 0 0 28px #00ffff, 0 0 36px #00ffff; transform: translate(-1px, 1px); opacity: 0.9; }
            40% { text-shadow: 0 0 6px #fff, 0 0 12px #fff, 0 0 20px #f00, 0 0 28px #f00, 0 0 36px #f00; transform: translate(1px, -1px); opacity: 1; }
            50% { text-shadow: 0 0 6px #fff, 0 0 12px #fff, 0 0 20px #ff00ff, 0 0 28px #ff00ff, 0 0 36px #ff00ff; transform: translate(-3px, 3px); opacity: 0.8; }
            60% { text-shadow: 0 0 6px #fff, 0 0 12px #fff, 0 0 20px #f00, 0 0 28px #f00, 0 0 36px #f00; transform: translate(3px, -3px); opacity: 1; }
            70% { text-shadow: 0 0 6px #fff, 0 0 12px #fff, 0 0 20px #00ffff, 0 0 28px #00ffff, 0 0 36px #00ffff; transform: translate(-2px, 2px); opacity: 0.9; }
            80% { text-shadow: 0 0 6px #fff, 0 0 12px #fff, 0 0 20px #f00, 0 0 28px #f00, 0 0 36px #f00; transform: translate(2px, -2px); opacity: 1; }
            90% { text-shadow: 0 0 6px #fff, 0 0 12px #fff, 0 0 20px #ff00ff, 0 0 28px #ff00ff, 0 0 36px #ff00ff; transform: translate(-1px, 1px); opacity: 0.9; }
        }
        .animate-text-glitch-glow {
            animation: text-glitch-glow 4s infinite alternate;
        }

        /* Button Neon Glow (Red) */
        @keyframes button-neon-glow-red {
            0%, 100% { box-shadow: 0 0 10px rgba(220, 38, 38, 0.7), 0 0 20px rgba(220, 38, 38, 0.5), 0 0 30px rgba(220, 38, 38, 0.3); }
            50% { box-shadow: 0 0 18px rgba(220, 38, 38, 0.9), 0 0 30px rgba(220, 38, 38, 0.7), 0 0 45px rgba(220, 38, 38, 0.5); }
        }
        .shadow-button-neon-glow-red {
            animation: button-neon-glow-red 2.5s infinite alternate;
        }

        /* Button Neon Glow (Purple) */
        @keyframes button-neon-glow-purple {
            0%, 100% { box-shadow: 0 0 10px rgba(168, 85, 247, 0.7), 0 0 20px rgba(168, 85, 247, 0.5), 0 0 30px rgba(168, 85, 247, 0.3); }
            50% { box-shadow: 0 0 18px rgba(168, 85, 247, 0.9), 0 0 30px rgba(168, 85, 247, 0.7), 0 0 45px rgba(168, 85, 247, 0.5); }
        }
        .shadow-button-neon-glow-purple {
            animation: button-neon-glow-purple 2.5s infinite alternate;
        }

        /* Button Neon Glow (Blue) */
        @keyframes button-neon-glow-blue {
            0%, 100% { box-shadow: 0 0 10px rgba(59, 130, 246, 0.7), 0 0 20px rgba(59, 130, 246, 0.5), 0 0 30px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 18px rgba(59, 130, 246, 0.9), 0 0 30px rgba(59, 130, 246, 0.7), 0 0 45px rgba(59, 130, 246, 0.5); }
        }
        .shadow-button-neon-glow-blue {
            animation: button-neon-glow-blue 2.5s infinite alternate;
        }

        /* Button Neon Glow (Yellow) */
        @keyframes button-neon-glow-yellow {
            0%, 100% { box-shadow: 0 0 10px rgba(252, 211, 77, 0.7), 0 0 20px rgba(252, 211, 77, 0.5), 0 0 30px rgba(252, 211, 77, 0.3); }
            50% { box-shadow: 0 0 18px rgba(252, 211, 77, 0.9), 0 0 30px rgba(252, 211, 77, 0.7), 0 0 45px rgba(252, 211, 77, 0.5); }
        }
        .shadow-button-neon-glow-yellow {
            animation: button-neon-glow-yellow 2.5s infinite alternate;
        }

        /* Button Neon Glow (Green) */
        @keyframes button-neon-glow-green {
            0%, 100% { box-shadow: 0 0 10px rgba(34, 197, 94, 0.7), 0 0 20px rgba(34, 197, 94, 0.5), 0 0 30px rgba(34, 197, 94, 0.3); }
            50% { box-shadow: 0 0 18px rgba(34, 197, 94, 0.9), 0 0 30px rgba(34, 197, 94, 0.7), 0 0 45px rgba(34, 197, 94, 0.5); }
        }
        .shadow-button-neon-glow-green {
            animation: button-neon-glow-green 2.5s infinite alternate;
        }

        /* Smaller Pulse Button */
        @keyframes pulse-btn {
            0% { transform: scale(1); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3), 0 0 0 rgba(0,0,0,0); }
            50% { transform: scale(1.02); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4), 0 0 10px rgba(255,255,255,0.3); }
            100% { transform: scale(1); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3), 0 0 0 rgba(0,0,0,0); }
        }
        .animate-pulse-btn {
            animation: pulse-btn 2.5s infinite ease-in-out;
        }

        /* Fade In Up (Small) */
        @keyframes fade-in-up-sm {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in-up-sm {
            animation: fade-in-up-sm 0.9s ease-out forwards;
        }

        /* Fade In Left (Small) */
        @keyframes fade-in-left-sm {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-fade-in-left-sm {
            animation: fade-in-left-sm 0.9s ease-out forwards;
        }

        /* Fade In Right (Small) */
        @keyframes fade-in-right-sm {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .animate-fade-in-right-sm {
            animation: fade-in-right-sm 0.9s ease-out forwards;
        }

        /* Pop In with Bounce */
        @keyframes pop-in-bounce {
            0% { transform: scale(0.7); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            75% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }
        .animate-pop-in-bounce {
            animation: pop-in-bounce 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* Message Pop In */
        @keyframes message-pop-in {
            from { opacity: 0; transform: translateY(10px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-message-pop-in {
            animation: message-pop-in 0.3s ease-out forwards;
        }

        /* Avatar Float */
        @keyframes avatar-float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        .animate-avatar-float {
            animation: avatar-float 2.5s infinite ease-in-out;
        }

        /* Text Pulse */
        @keyframes pulse-text {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.01); opacity: 0.95; }
        }
        .animate-pulse-text {
            animation: pulse-text 1.8s infinite ease-in-out;
        }

        /* Custom Shadows (Smaller versions) */
        .shadow-neon-red-sm {
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.6), 0 0 30px rgba(220, 38, 38, 0.4);
        }
        .shadow-neon-purple-sm {
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.6), 0 0 30px rgba(168, 85, 247, 0.4);
        }
        .shadow-neon-blue-sm {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.6), 0 0 30px rgba(59, 130, 246, 0.4);
        }
        .shadow-neon-green-sm {
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.6), 0 0 30px rgba(34, 197, 94, 0.4);
        }
        .shadow-inner-neon-red {
            box-shadow: inset 0 0 10px rgba(220, 38, 38, 0.25), inset 0 0 15px rgba(220, 38, 38, 0.1);
        }
        .shadow-inner-neon-purple {
            box-shadow: inset 0 0 10px rgba(168, 85, 247, 0.25), inset 0 0 15px rgba(168, 85, 247, 0.1);
        }
        .shadow-inner-neon-yellow {
            box-shadow: inset 0 0 10px rgba(252, 211, 77, 0.25), inset 0 0 15px rgba(252, 211, 77, 0.1);
        }
        .shadow-avatar-neon-glow {
            box-shadow: 0 0 8px rgba(220, 38, 38, 0.4), 0 0 15px rgba(168, 85, 247, 0.2);
        }
        .shadow-message {
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.15), 0 0 3px rgba(255,255,255,0.08);
        }
        .text-shadow-lg {
            text-shadow: 0 0 6px rgba(255,255,255,0.5), 0 0 10px rgba(255,255,255,0.3);
        }
        .text-shadow-sm {
            text-shadow: 0 0 4px rgba(255,255,255,0.3);
        }
    </style>
</head>
<body class="font-inter">
    <div id="app-root">
        <!-- Content will be rendered here by JavaScript -->
        <div class="flex items-center justify-center min-h-screen bg-black text-white text-2xl animate-pulse">
            Initializing Quantum Game Engine...
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Firebase CDN Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, addDoc, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global State Variables
        let gamePhase = 'home';
        let playerName = '';
        let otherPlayerName = '';
        let gameCode = '';
        let messages = [];
        let thinkerId = null;
        let guesserId = null;
        let currentPlayerId = null;
        let correctCharacter = '';
        let playerSeries = '';
        let playerCharacter = '';
        let otherPlayerSeries = '';
        let otherPlayerCharacter = '';
        let db = null;
        let auth = null;
        let isAuthReady = false;
        let messageCount = 0; // For hint cooldown
        let isGeneratingHint = false; // To prevent multiple hint requests
        let feedbackMessage = ''; // Global feedback message state

        // Firebase Configuration (Your provided keys)
        const firebaseConfig = {
            apiKey: "AIzaSyDG108yI9TJltunEG4GFI0Kyah60QCjk4M",
            authDomain: "guessgame-7b132.firebaseapp.com",
            projectId: "guessgame-7b132",
            storageBucket: "guessgame-7b132.firebasestorage.app",
            messagingSenderId: "294083866383",
            appId: "1:294083866383:web:ad24d06184ea45595d987a",
            measurementId: "G-8EQG8B29ZV"
        };
        const GEMINI_API_KEY = "AIzaSyD2dY5BdDz8Q_Bixchg3XNkaHA36wBVMfA"; // Your Gemini API Key

        // --- Utility Functions ---
        const generateGameCode = () => Math.random().toString(36).substring(2, 8).toUpperCase();
        // Fallback for __app_id if not in Canvas environment
        const getAppId = () => typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- DOM Manipulation Helpers ---
        const getElement = (id) => document.getElementById(id);
        const setHtml = (id, html) => {
            const el = getElement(id);
            if (el) el.innerHTML = html;
        };
        const showElement = (id) => {
            const el = getElement(id);
            if (el) el.classList.remove('hidden');
        };
        const hideElement = (id) => {
            const el = getElement(id);
            if (el) el.classList.add('hidden');
        };

        // --- Message Box Logic ---
        function showMessageBox(msg, type) {
            const appRoot = getElement('app-root');
            const messageBoxHtml = `
                <div id="message-box-overlay" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div class="relative ${type === 'error' ? 'bg-red-900' : 'bg-indigo-900'} border-2 ${type === 'error' ? 'border-red-700' : 'border-indigo-700'} rounded-2xl shadow-neon-red-sm p-8 max-w-sm w-full text-center transform scale-100 animate-pop-in-bounce">
                        <p class="text-white text-2xl font-extrabold mb-6 tracking-wide text-shadow-sm">${msg}</p>
                        <button id="message-box-ok-btn" class="bg-gradient-to-r from-purple-700 to-fuchsia-800 hover:from-purple-800 hover:to-fuchsia-900 text-white font-bold py-3 px-8 rounded-lg shadow-button-neon-glow transform transition-all duration-300 hover:scale-105 border-b-4 border-purple-900 hover:border-purple-950 text-base animate-pulse-btn">
                            Got it!
                        </button>
                    </div>
                </div>
            `;
            appRoot.insertAdjacentHTML('beforeend', messageBoxHtml);
            getElement('message-box-ok-btn').onclick = hideMessageBox;
        }

        function hideMessageBox() {
            const overlay = getElement('message-box-overlay');
            if (overlay) overlay.remove();
        }

        // --- Player Avatar Logic ---
        function getPlayerAvatarHtml(name, size) {
            const initials = name ? name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0,1) : '?';
            const sizeClasses = {
                sm: 'w-8 h-8 text-xs',
                md: 'w-10 h-10 text-sm',
                lg: 'w-12 h-12 text-base',
            };
            return `
                <div class="flex items-center justify-center rounded-full bg-gradient-to-br from-red-600 to-purple-700 text-white font-extrabold ${sizeClasses[size]} shadow-avatar-neon-glow flex-shrink-0 border-2 border-red-400 animate-avatar-float">
                    ${initials}
                </div>
            `;
        }

        // --- Clipboard Copy Function ---
        function copyCodeToClipboard() {
            const el = document.createElement('textarea');
            el.value = gameCode;
            document.body.appendChild(el);
            el.select();
            try {
                document.execCommand('copy');
                showMessageBox('Game code copied to clipboard! Share it with your comrade!', 'info');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showMessageBox('Clipboard magic failed! Copy manually: ' + gameCode, 'error');
            } finally {
                document.body.removeChild(el);
            }
        }

        // --- Render Functions for Pages ---
        function renderHomePage() {
            setHtml('app-root', `
                <div class="relative flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-black via-gray-950 to-red-950 text-white p-4 overflow-hidden font-sans">
                    <div class="absolute inset-0 z-0 opacity-15 animate-bg-grid-glow-red"></div>
                    <div class="relative z-10 bg-gray-900 bg-opacity-80 backdrop-filter backdrop-blur-lg p-6 rounded-2xl shadow-neon-red-sm w-full max-w-md text-center transform transition-all duration-700 hover:scale-105 border-3 border-red-700 animate-fade-in-up-sm">
                        <h1 class="text-4xl font-extrabold mb-6 text-transparent bg-clip-text bg-gradient-to-r from-red-400 via-orange-300 to-yellow-400 animate-text-glitch-glow leading-tight tracking-wide">
                            The Ultimate Guessing Game
                        </h1>

                        <input id="name-input" type="text" placeholder="Your Epic Player Name" class="w-full p-3 mb-4 bg-gray-900 bg-opacity-70 border-2 border-red-600 rounded-lg focus:outline-none focus:ring-4 focus:ring-red-400 text-lg placeholder-gray-500 transition duration-300 ease-in-out shadow-inner-neon-red text-center" />

                        <button id="create-game-btn" class="w-full bg-gradient-to-r from-red-600 to-red-800 hover:from-red-700 hover:to-red-900 text-white font-bold py-4 px-6 rounded-lg shadow-button-neon-glow-red transform transition-all duration-300 hover:scale-105 mb-4 text-xl border-b-4 border-red-900 hover:border-red-950 animate-pulse-btn">
                            Forge New Destiny (Create Game)
                        </button>

                        <button id="show-join-input-btn" class="w-full bg-gradient-to-r from-purple-600 to-indigo-700 hover:from-purple-700 hover:to-indigo-800 text-white font-bold py-4 px-6 rounded-lg shadow-button-neon-glow-purple transform transition-all duration-300 hover:scale-105 text-xl border-b-4 border-purple-800 hover:border-purple-900 animate-pulse-btn">
                            Join Epic Quest (Join with Code)
                        </button>

                        <div id="join-game-section" class="mt-6 hidden">
                            <input id="join-code-input" type="text" placeholder="Secret Game Code" class="w-full p-3 mb-4 bg-gray-900 bg-opacity-70 border-2 border-purple-600 rounded-lg focus:outline-none focus:ring-4 focus:ring-purple-400 text-lg placeholder-gray-500 transition duration-300 ease-in-out shadow-inner-neon-purple text-center" />
                            <button id="join-game-btn" class="w-full bg-gradient-to-r from-indigo-600 to-blue-700 hover:from-indigo-700 hover:to-blue-800 text-white font-bold py-4 px-6 rounded-lg shadow-button-neon-glow-blue transform transition-all duration-300 hover:scale-105 text-xl border-b-4 border-indigo-800 hover:border-indigo-900 animate-pulse-btn">
                                Embark!
                            </button>
                        </div>
                    </div>
                </div>
            `);

            // Attach event listeners
            getElement('name-input').oninput = (e) => playerName = e.target.value;
            getElement('create-game-btn').onclick = () => {
                if (playerName.trim()) {
                    createGame();
                } else {
                    showMessageBox('Who are you, mysterious player? Enter your name!', 'error');
                }
            };
            getElement('show-join-input-btn').onclick = () => {
                showElement('join-game-section');
                hideElement('show-join-input-btn');
            };
            getElement('join-code-input').oninput = (e) => gameCode = e.target.value;
            getElement('join-game-btn').onclick = () => {
                if (playerName.trim() && gameCode.trim()) {
                    joinGame(gameCode.trim().toUpperCase());
                } else {
                    showMessageBox('Don\'t be shy! Enter your name AND the secret code!', 'error');
                }
            };
        }

        function renderGameLobby() {
            setHtml('app-root', `
                <div class="relative flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-black via-gray-950 to-red-950 text-white p-4 overflow-hidden font-sans">
                    <div class="absolute inset-0 z-0 opacity-15 animate-bg-grid-glow-red"></div>
                    <div class="relative z-10 bg-gray-900 bg-opacity-80 backdrop-filter backdrop-blur-lg p-6 rounded-2xl shadow-neon-red-sm w-full max-w-md text-center transform transition-all duration-700 hover:scale-105 border-3 border-red-700 animate-fade-in-up-sm">
                        <h2 class="text-4xl font-bold mb-6 text-transparent bg-clip-text bg-gradient-to-r from-red-400 via-orange-300 to-yellow-400 animate-text-glitch-glow">
                            The Grand Lobby
                        </h2>

                        <p class="text-xl mb-4 font-semibold text-shadow-sm">
                            Game Code: <span class="font-mono text-yellow-400 text-3xl font-extrabold tracking-wider animate-pulse-text">${gameCode}</span>
                        </p>
                        <button id="copy-code-btn" class="bg-gradient-to-r from-red-600 to-red-800 hover:from-red-700 hover:to-red-900 text-white font-bold py-3 px-6 rounded-xl shadow-button-neon-glow-red transition duration-300 ease-in-out transform hover:scale-105 mb-6 border-b-4 border-red-900 hover:border-red-950 text-base animate-pulse-btn">
                            Copy Code to Scroll!
                        </button>

                        <div class="flex justify-around items-center mb-8 bg-gray-900 bg-opacity-70 p-4 rounded-xl border-2 border-gray-800 shadow-inner-neon-red animate-fade-in">
                            <div class="text-center flex flex-col items-center">
                                ${getPlayerAvatarHtml(playerName, 'lg')}
                                <p class="text-lg font-semibold mt-2 text-shadow-sm">You:</p>
                                <p class="text-2xl text-red-300 font-bold tracking-wide text-shadow-sm">${playerName}</p>
                            </div>
                            <div class="text-center flex flex-col items-center">
                                ${getPlayerAvatarHtml(otherPlayerName, 'lg')}
                                <p class="text-lg font-semibold mt-2 text-shadow-sm">Your Rival:</p>
                                <p class="text-2xl text-purple-300 font-bold tracking-wide text-shadow-sm">
                                    ${otherPlayerName || 'Summoning...'}
                                </p>
                            </div>
                        </div>

                        <p class="text-base text-gray-300 text-shadow-sm">
                            Prepare your mind! Once your comrade arrives, the ritual of character selection begins.
                        </p>
                        <p class="text-sm text-gray-400 mt-2">
                            (In this simulation, a virtual challenger will appear shortly)
                        </p>
                    </div>
                </div>
            `);
            getElement('copy-code-btn').onclick = copyCodeToClipboard;
        }

        function renderCharacterSetupPage() {
            setHtml('app-root', `
                <div class="relative flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-black via-gray-950 to-red-950 text-white p-4 overflow-hidden font-sans">
                    <div class="absolute inset-0 z-0 opacity-15 animate-bg-grid-glow-red"></div>
                    <div class="relative z-10 bg-gray-900 bg-opacity-80 backdrop-filter backdrop-blur-lg p-6 rounded-2xl shadow-neon-red-sm w-full max-w-md text-center transform transition-all duration-700 hover:scale-105 border-3 border-red-700 animate-fade-in-up-sm">
                        <h2 class="text-4xl font-bold mb-6 text-transparent bg-clip-text bg-gradient-to-r from-red-400 via-orange-300 to-yellow-400 animate-text-glitch-glow">
                            Choose Your Champion!
                        </h2>

                        <p class="text-base mb-4 text-gray-300 text-shadow-sm">
                            Select a character from any Anime, Manga, or Novel. Keep it a secret!
                        </p>

                        <input id="series-input" type="text" placeholder="Series Name (e.g., Jujutsu Kaisen)" class="w-full p-3 mb-4 bg-gray-900 bg-opacity-70 border-2 border-red-600 rounded-xl focus:outline-none focus:ring-4 focus:ring-red-400 text-lg placeholder-gray-500 transition duration-300 ease-in-out shadow-inner-neon-red text-center" />
                        <input id="character-input" type="text" placeholder="Character Name (e.g., Satoru Gojo)" class="w-full p-3 mb-6 bg-gray-900 bg-opacity-70 border-2 border-red-600 rounded-xl focus:outline-none focus:ring-4 focus:ring-red-400 text-lg placeholder-gray-500 transition duration-300 ease-in-out shadow-inner-neon-red text-center" />

                        <button id="submit-character-btn" class="w-full bg-gradient-to-r from-red-600 to-red-800 hover:from-red-700 hover:to-red-900 text-white font-bold py-4 px-6 rounded-xl shadow-button-neon-glow-red transform transition-all duration-300 hover:scale-105 text-xl border-b-4 border-red-900 hover:border-red-950 animate-pulse-btn">
                            Lock In Your Secret!
                        </button>
                    </div>
                </div>
            `);

            const seriesInputEl = getElement('series-input');
            const characterInputEl = getElement('character-input');
            const submitBtn = getElement('submit-character-btn');

            seriesInputEl.oninput = (e) => playerSeries = e.target.value;
            characterInputEl.oninput = (e) => playerCharacter = e.target.value;
            submitBtn.onclick = handleSubmitCharacter;

            if (playerSeries && playerCharacter) { // If already submitted
                seriesInputEl.value = playerSeries;
                characterInputEl.value = playerCharacter;
                seriesInputEl.disabled = true;
                characterInputEl.disabled = true;
                submitBtn.disabled = true;
                submitBtn.textContent = 'Awaiting Rival\'s Choice...';
            }
        }

        function renderGameChat() {
            const isThinker = thinkerId === currentPlayerId;
            const isGuesser = guesserId === currentPlayerId;

            setHtml('app-root', `
                <div class="relative flex min-h-screen bg-gradient-to-br from-black via-blue-950 to-indigo-950 text-white p-6 overflow-hidden font-sans">
                    <div class="absolute inset-0 z-0 opacity-15 animate-bg-grid-glow-blue"></div>

                    <!-- Sidebar -->
                    <div class="relative z-10 w-64 bg-gray-900 bg-opacity-80 backdrop-filter backdrop-blur-lg p-6 rounded-3xl shadow-neon-purple-md border-3 border-purple-700 mr-6 flex flex-col animate-fade-in-left-sm">
                        <h3 class="text-3xl font-bold mb-6 text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-yellow-300 animate-text-glitch-glow text-shadow-sm">
                            Awesome
                        </h3>
                        <div class="flex flex-col space-y-4">
                            <div class="flex items-center bg-gray-900 bg-opacity-70 p-3 rounded-xl shadow-inner-neon-red border-2 border-gray-800">
                                ${getPlayerAvatarHtml(playerName, 'sm')}
                                <div class="ml-3">
                                    <p class="text-lg font-semibold text-shadow-sm">${playerName}</p>
                                    <p class="text-xs mt-1 ${isThinker ? 'text-red-400 font-bold' : 'text-purple-400 font-bold'}">
                                        ${isThinker ? 'Thinker (You)' : 'Guesser (You)'}
                                    </p>
                                </div>
                            </div>
                            <div class="flex items-center bg-gray-900 bg-opacity-70 p-3 rounded-xl shadow-inner-neon-purple border-2 border-gray-800">
                                ${getPlayerAvatarHtml(otherPlayerName, 'sm')}
                                <div class="ml-3">
                                    <p class="text-lg font-semibold text-shadow-sm">${otherPlayerName}</p>
                                    <p class="text-xs mt-1 ${!isThinker ? 'text-red-400 font-bold' : 'text-purple-400 font-bold'}">
                                        ${!isThinker ? 'Thinker (Rival)' : 'Guesser (Rival)'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Chat Area -->
                    <div class="relative z-10 flex-grow bg-gray-900 bg-opacity-80 backdrop-filter backdrop-blur-lg p-8 rounded-3xl shadow-neon-red-md border-3 border-red-700 flex flex-col animate-fade-in-right-sm">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-300 via-orange-300 to-yellow-300 animate-text-glitch-glow">
                                The Grand Interrogation
                            </h2>
                            ${isGuesser ? `
                                <button id="get-hint-btn" class="bg-gradient-to-r from-purple-700 to-fuchsia-800 hover:from-purple-800 hover:to-fuchsia-900 text-white font-bold py-2 px-4 rounded-lg shadow-button-neon-glow-purple transition duration-300 ease-in-out transform hover:scale-105 border-b-4 border-purple-900 hover:border-purple-950 text-sm ${isGeneratingHint || messageCount < 4 ? 'opacity-50 cursor-not-allowed' : ''}" ${isGeneratingHint || messageCount < 4 ? 'disabled' : ''}>
                                    ${isGeneratingHint ? 'Summoning...' : `Hint (${messageCount}/4)`}
                                </button>
                            ` : ''}
                        </div>

                        <div id="messages-container" class="flex-grow bg-gray-900 bg-opacity-70 p-5 rounded-2xl mb-6 overflow-y-auto custom-scrollbar border-2 border-gray-800 shadow-inner-neon-red animate-fade-in" style="max-height: calc(100vh - 220px);">
                            ${messages.length === 0 ? `
                                <p class="text-center text-gray-500 mt-4 text-base text-shadow-sm">
                                    The stage is set! ${isThinker ? `You're thinking of a character from ${playerSeries}.` : `It's your turn to unravel the mystery of ${otherPlayerSeries}'s character! Ask away!`}
                                </p>
                            ` : ''}
                            ${messages.map(msg => `
                                <div class="mb-3 flex items-start ${msg.senderId === currentPlayerId ? 'justify-end' : 'justify-start'} animate-message-pop-in">
                                    ${msg.senderId !== currentPlayerId ? getPlayerAvatarHtml(msg.senderName, 'sm') : ''}
                                    <div class="p-3 rounded-lg max-w-[75%] shadow-message transition-all duration-300 ${msg.senderId === currentPlayerId ? 'bg-red-700 text-white ml-3 border-2 border-red-500' : 'bg-gray-700 text-gray-100 mr-3 border-2 border-gray-600'} ${msg.role === 'AI' ? 'bg-purple-800 border-2 border-purple-600 shadow-neon-purple' : ''}">
                                        <p class="font-bold text-xs mb-1 opacity-80 text-red-200">
                                            ${msg.senderName} (${msg.role})
                                        </p>
                                        <p class="text-sm leading-relaxed">${msg.text}</p>
                                    </div>
                                    ${msg.senderId === currentPlayerId ? getPlayerAvatarHtml(msg.senderName, 'sm') : ''}
                                </div>
                            `).join('')}
                            <div id="chat-end-ref"></div>
                        </div>

                        <div id="feedback-message-container">
                            ${feedbackMessage ? `
                                <div class="text-center py-3 rounded-xl mb-6 text-lg font-semibold animate-fade-in ${feedbackMessage.includes('Victory') ? 'bg-green-700 shadow-neon-green-md' : 'bg-red-700 shadow-neon-red-md'}">
                                    ${feedbackMessage}
                                </div>
                            ` : ''}
                        </div>

                        <div class="flex mt-auto gap-3">
                            <input id="message-input" type="text" placeholder="${isGuesser ? "Unleash your question..." : "Craft your witty response..."}" class="flex-grow p-3 bg-gray-900 bg-opacity-70 border-2 border-gray-800 rounded-lg focus:outline-none focus:ring-4 focus:ring-red-400 text-base placeholder-gray-500 transition duration-300 ease-in-out shadow-inner-neon-red" ${!isGuesser && !isThinker ? 'disabled' : ''} />
                            <button id="send-message-btn" class="bg-gradient-to-r from-red-600 to-red-800 hover:from-red-700 hover:to-red-900 text-white font-bold py-3 px-6 rounded-lg shadow-button-neon-glow-red transition duration-300 ease-in-out transform hover:scale-105 border-b-4 border-red-900 hover:border-red-950 text-base" ${!isGuesser && !isThinker ? 'disabled' : ''}>
                                Send It!
                            </button>
                        </div>

                        ${isGuesser ? `
                            <div class="mt-6 text-center flex flex-col md:flex-row gap-3">
                                <button id="make-guess-toggle-btn" class="flex-grow bg-gradient-to-r from-yellow-600 to-orange-700 hover:from-yellow-700 hover:to-orange-800 text-white font-bold py-4 px-8 rounded-lg shadow-button-neon-glow-yellow transform transition-all duration-300 hover:scale-105 border-b-4 border-yellow-800 hover:border-yellow-900 animate-pulse-btn">
                                    Make Your Grand Guess!
                                </button>
                                <div id="guess-input-section" class="flex flex-grow gap-3 hidden">
                                    <input id="guess-input" type="text" placeholder="Your Masterful Guess (Series & Character)" class="flex-grow p-3 bg-gray-900 bg-opacity-70 border-2 border-gray-800 rounded-lg focus:outline-none focus:ring-4 focus:ring-yellow-400 text-base placeholder-gray-500 transition duration-300 ease-in-out shadow-inner-neon-yellow" />
                                    <button id="confirm-guess-btn" class="bg-gradient-to-r from-green-600 to-teal-700 hover:from-green-700 hover:to-teal-800 text-white font-bold py-3 px-6 rounded-lg shadow-button-neon-glow-green transition duration-300 ease-in-out transform hover:scale-105 border-b-4 border-green-800 hover:border-green-900 text-base">
                                        Confirm Destiny!
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `);

            // Attach event listeners
            const messageInputEl = getElement('message-input');
            const sendBtn = getElement('send-message-btn');
            const messagesContainer = getElement('messages-container'); // Not directly used for scrolling, but good to have
            const chatEndRef = getElement('chat-end-ref');

            messageInputEl.oninput = (e) => currentMessage = e.target.value;
            sendBtn.onclick = handleSendMessage;
            messageInputEl.onkeypress = (e) => { if (e.key === 'Enter') handleSendMessage(); };

            if (isGuesser) {
                const hintBtn = getElement('get-hint-btn');
                const makeGuessToggleBtn = getElement('make-guess-toggle-btn');
                const guessInputSection = getElement('guess-input-section');
                const guessInputEl = getElement('guess-input');
                const confirmGuessBtn = getElement('confirm-guess-btn');

                if (hintBtn) hintBtn.onclick = handleGetHint;
                if (makeGuessToggleBtn) makeGuessToggleBtn.onclick = () => {
                    hideElement('make-guess-toggle-btn');
                    showElement('guess-input-section');
                };
                if (guessInputEl) guessInputEl.oninput = (e) => guessInput = e.target.value;
                if (confirmGuessBtn) confirmGuessBtn.onclick = handleMakeGuess;
                if (guessInputEl) guessInputEl.onkeypress = (e) => { if (e.key === 'Enter') handleMakeGuess(); };
            }

            // Scroll to bottom
            if (chatEndRef) chatEndRef.scrollIntoView({ behavior: 'smooth' });
        }

        function renderEndOfRoundScreen() {
            setHtml('app-root', `
                <div class="relative flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-black via-gray-950 to-red-950 text-white p-4 overflow-hidden font-sans">
                    <div class="absolute inset-0 z-0 opacity-15 animate-bg-grid-glow-red"></div>
                    <div class="relative z-10 bg-gray-900 bg-opacity-80 backdrop-filter backdrop-blur-lg p-6 rounded-2xl shadow-neon-red-sm w-full max-w-md text-center transform transition-all duration-700 hover:scale-105 border-3 border-red-700 animate-fade-in-up-sm">
                        <h2 class="text-4xl font-bold mb-6 text-transparent bg-clip-text bg-gradient-to-r from-red-400 via-orange-300 to-yellow-400 animate-text-glitch-glow leading-tight">
                            Round Concluded!
                        </h2>

                        <p class="text-xl mb-4 font-semibold text-shadow-sm">
                            The true identity was:
                        </p>
                        <p class="text-4xl font-extrabold text-red-400 mb-8 animate-bounce-slow tracking-wide text-shadow-lg">
                            ${correctCharacter}
                        </p>

                        <button id="switch-roles-btn" class="w-full bg-gradient-to-r from-purple-700 to-fuchsia-800 hover:from-purple-800 hover:to-fuchsia-900 text-white font-bold py-4 px-8 rounded-xl shadow-button-neon-glow-purple transform transition-all duration-300 hover:scale-105 text-xl border-b-4 border-purple-900 hover:border-purple-950 animate-pulse-btn">
                            Begin Next Saga (Switch Roles)
                        </button>
                    </div>
                </div>
            `);
            getElement('switch-roles-btn').onclick = switchRoles;
        }

        // --- Game State Management & Render Loop ---
        function updateUI() {
            // This function is called to re-render the current game phase based on global state
            switch (gamePhase) {
                case 'home':
                    renderHomePage();
                    break;
                case 'lobby':
                    renderGameLobby();
                    break;
                case 'characterSetup':
                    renderCharacterSetupPage();
                    break;
                case 'game':
                    renderGameChat();
                    break;
                case 'endRound':
                    renderEndOfRoundScreen();
                    break;
                default:
                    renderHomePage(); // Fallback
            }
        }

        // --- Firebase Integration ---
        let unsubscribeGameRoom = null; // Declare here to be accessible globally
        let unsubscribeMessages = null; // Declare for messages listener

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Always sign in anonymously for standalone HTML to avoid __initial_auth_token issues
                await signInAnonymously(auth);

                // Listen for auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentPlayerId = user.uid;
                    } else {
                        currentPlayerId = null;
                    }
                    isAuthReady = true;
                    updateUI(); // Initial UI render after auth is ready
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessageBox("Failed to initialize game. Please check your internet connection and try again.", "error");
            }
        }

        // Create Game in Firestore
        async function createGame() {
            if (!db || !currentPlayerId || !playerName) {
                showMessageBox("Firebase not ready or player name missing!", "error");
                return;
            }
            const newGameCode = generateGameCode();
            gameCode = newGameCode; // Update global state

            const appId = getAppId();
            const gameRoomRef = doc(db, `artifacts/${appId}/public/data/gameRooms`, newGameCode);
            try {
                await setDoc(gameRoomRef, {
                    players: {
                        [currentPlayerId]: { name: playerName, status: 'connected', character: null, series: null, role: null }
                    },
                    messages: [],
                    status: 'waiting',
                    createdAt: new Date(),
                    thinkerId: null,
                    guesserId: null,
                });
                gamePhase = 'lobby';
                updateUI();
                setupGameRoomListener(); // Start listening for changes in the lobby
            } catch (error) {
                console.error("Error creating game:", error);
                showMessageBox("Failed to create game. Please try again.", "error");
            }
        }

        // Join Game in Firestore
        async function joinGame(code) {
            if (!db || !currentPlayerId || !playerName) {
                showMessageBox("Firebase not ready or player name missing!", "error");
                return;
            }
            gameCode = code; // Update global state

            const appId = getAppId();
            const gameRoomRef = doc(db, `artifacts/${appId}/public/data/gameRooms`, code);

            try {
                const docSnap = await getDoc(gameRoomRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const players = data.players || {};
                    if (Object.keys(players).length >= 2) {
                        showMessageBox("Game room is full! Find another one or create your own.", "error");
                        return;
                    }
                    await updateDoc(gameRoomRef, {
                        [`players.${currentPlayerId}`]: { name: playerName, status: 'connected', character: null, series: null, role: null }
                    });
                    gamePhase = 'lobby';
                    updateUI();
                    setupGameRoomListener(); // Start listening for changes in the lobby
                } else {
                    showMessageBox("Game room does not exist! Check the code or create a new game.", "error");
                }
            } catch (error) {
                console.error("Error joining game:", error);
                showMessageBox("Error joining game. Please try again.", "error");
            }
        }

        // Listener for game room state changes (used in Lobby and Character Setup)
        function setupGameRoomListener() {
            if (unsubscribeGameRoom) unsubscribeGameRoom(); // Unsubscribe from previous listener if any

            const appId = getAppId();
            const gameRoomRef = doc(db, `artifacts/${appId}/public/data/gameRooms`, gameCode);

            unsubscribeGameRoom = onSnapshot(gameRoomRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const players = data.players || {};
                    const playerIds = Object.keys(players);

                    const otherPlayerId = playerIds.find(id => id !== currentPlayerId);
                    if (otherPlayerId && players[otherPlayerId]) {
                        otherPlayerName = players[otherPlayerId].name;
                        otherPlayerSeries = players[otherPlayerId].series || '';
                        otherPlayerCharacter = players[otherPlayerId].character || '';
                    } else {
                        otherPlayerName = ''; // Clear if other player disconnects
                        otherPlayerSeries = '';
                        otherPlayerCharacter = '';
                    }

                    // Update roles from Firestore
                    thinkerId = data.thinkerId;
                    guesserId = data.guesserId;

                    // Logic for phase transitions
                    if (playerIds.length === 2 && data.status === 'waiting') {
                        gamePhase = 'characterSetup';
                    } else if (playerIds.length === 2 && players[playerIds[0]].character && players[playerIds[0]].series &&
                               players[playerIds[1]].character && players[playerIds[1]].series && data.status !== 'roundEnded') {
                        gamePhase = 'game';
                        setupMessagesListener(); // Start listening for messages only when game starts
                    } else if (data.status === 'roundEnded') {
                        gamePhase = 'endRound';
                        correctCharacter = data.lastCorrectGuess ? `${data.lastCorrectGuess.character} (${data.lastCorrectGuess.series})` : '';
                    }

                    updateUI();
                } else {
                    // Game room deleted or does not exist
                    console.warn("Game room no longer exists. Returning to home.");
                    gamePhase = 'home';
                    gameCode = '';
                    otherPlayerName = '';
                    playerSeries = '';
                    playerCharacter = '';
                    thinkerId = null;
                    guesserId = null;
                    if (unsubscribeGameRoom) unsubscribeGameRoom(); // Clear listener
                    unsubscribeGameRoom = null;
                    if (unsubscribeMessages) unsubscribeMessages(); // Clear messages listener
                    unsubscribeMessages = null;
                    updateUI();
                    showMessageBox("The game room was closed or no longer exists.", "info");
                }
            }, (error) => {
                console.error("Error listening to game room:", error);
                showMessageBox("Lost connection to game. Please try refreshing.", "error");
            });
        }

        // Listener for real-time messages from Firestore
        function setupMessagesListener() {
            if (unsubscribeMessages) unsubscribeMessages(); // Unsubscribe from previous listener if any

            const appId = getAppId();
            const messagesRef = collection(db, `artifacts/${appId}/public/data/gameRooms`, gameCode, 'messages');
            const q = query(messagesRef, orderBy('timestamp'));

            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                messages = snapshot.docs.map(doc => ({
                    ...doc.data(),
                    id: doc.id,
                    isMine: doc.data().senderId === currentPlayerId // Determine if message is from current user
                }));
                // Update message count based on fetched messages for hint cooldown
                messageCount = messages.filter(msg => msg.role !== 'AI').length;
                updateUI(); // Re-render chat to show new messages
            }, (error) => {
                console.error("Error fetching messages:", error);
                showMessageBox("Failed to load messages. Please check console.", "error");
            });
        }


        // Handle Character Submission
        async function handleSubmitCharacter() {
            if (!db || !currentPlayerId || !gameCode || !playerSeries.trim() || !playerCharacter.trim()) {
                showMessageBox('Please enter both series and character names.', 'error');
                return;
            }

            const appId = getAppId();
            const gameRoomRef = doc(db, `artifacts/${appId}/public/data/gameRooms`, gameCode);

            try {
                await updateDoc(gameRoomRef, {
                    [`players.${currentPlayerId}.series`]: playerSeries.trim(),
                    [`players.${currentPlayerId}.character`]: playerCharacter.trim(),
                });
                // UI will update via onSnapshot listener in setupGameRoomListener
                showMessageBox('Your secret is safe! Waiting for your opponent to choose their fate...', 'info');
            } catch (error) {
                console.error("Error submitting character:", error);
                showMessageBox("Failed to lock in character. Try again.", "error");
            }
        }

        // Handle Send Message
        async function handleSendMessage() {
            const messageInputEl = getElement('message-input');
            const messageText = messageInputEl ? messageInputEl.value.trim() : '';

            if (messageText && db && currentPlayerId && gameCode) {
                const appId = getAppId();
                const messagesRef = collection(db, `artifacts/${appId}/public/data/gameRooms`, gameCode, 'messages');

                try {
                    await addDoc(messagesRef, {
                        senderId: currentPlayerId,
                        senderName: playerName,
                        text: messageText,
                        timestamp: new Date(),
                        role: thinkerId === currentPlayerId ? 'Thinker' : 'Guesser'
                    });
                    if (messageInputEl) messageInputEl.value = ''; // Clear input
                } catch (error) {
                    console.error("Error sending message:", error);
                    showMessageBox("Failed to send message. Check connection.", "error");
                }
            }
        }

        // Handle Make Guess
        async function handleMakeGuess() {
            const guessInputEl = getElement('guess-input');
            const guessText = guessInputEl ? guessInputEl.value.trim() : '';

            if (guessText && db && currentPlayerId && gameCode) {
                const appId = getAppId();
                const messagesRef = collection(db, `artifacts/${appId}/public/data/gameRooms`, gameCode, 'messages');
                const gameRoomRef = doc(db, `artifacts/${appId}/public/data/gameRooms`, gameCode);

                const actualCorrectCharacter = guesserId === currentPlayerId ? otherPlayerCharacter : playerCharacter;
                const actualCorrectSeries = guesserId === currentPlayerId ? otherPlayerSeries : playerSeries;

                if (guessText.toLowerCase() === actualCorrectCharacter.toLowerCase()) {
                    feedbackMessage = `Victory! The character was indeed ${actualCorrectCharacter} from ${actualCorrectSeries}! You are a true master! (Or just lucky. Mostly lucky.)`;
                    // Record the correct guess in Firestore
                    await addDoc(messagesRef, {
                        senderId: currentPlayerId,
                        senderName: playerName,
                        text: `I guess: ${guessText} - CORRECT!`,
                        timestamp: new Date(),
                        role: 'Guesser'
                    });
                    // Update game state in Firestore for round end and role switch
                    await updateDoc(gameRoomRef, {
                        lastCorrectGuess: { character: actualCorrectCharacter, series: actualCorrectSeries, guesserId: currentPlayerId },
                        status: 'roundEnded',
                        thinkerId: guesserId, // Swap roles for next round
                        guesserId: thinkerId,
                    });
                } else {
                    feedbackMessage = 'A valiant effort, but alas, your guess was as off as a villain\'s redemption arc! Try again! (And maybe read more books. Seriously.)';
                    // Record the wrong guess in Firestore
                    await addDoc(messagesRef, {
                        senderId: currentPlayerId,
                        senderName: playerName,
                        text: `I guess: ${guessText} - WRONG!`,
                        timestamp: new Date(),
                        role: 'Guesser'
                    });
                }
                updateUI(); // Re-render to show feedback
                setTimeout(() => feedbackMessage = '', 2000); // Clear feedback
                if (guessInputEl) guessInputEl.value = '';
                // The phase change to 'endRound' will be handled by the game room listener
            }
        }

        // Handle Get Hint (AI)
        async function handleGetHint() {
            if (messageCount < 4) {
                showMessageBox(`The Oracle is busy contemplating its superiority. You need ${4 - messageCount} more questions/guesses before it deigns to help.`, 'error');
                return;
            }

            isGeneratingHint = true;
            showMessageBox('Summoning the Oracle of Sarcasm for a hint... this might hurt your ego.', 'info');
            updateUI(); // Update button state

            const targetCharacter = guesserId === currentPlayerId ? otherPlayerCharacter : playerCharacter;
            const targetSeries = guesserId === currentPlayerId ? otherPlayerSeries : playerSeries;

            const chatHistoryForLLM = messages.map(msg => ({
                role: msg.senderId === currentPlayerId ? "user" : "model", // Use senderId to determine role for LLM
                parts: [{ text: msg.text }]
            }));

            const prompt = `You are a highly sarcastic, witty, and slightly unhinged AI assistant. The user is playing a guessing game about characters from Anime, Manga, or Novels. They need a *subtle, funny, or sarcastic hint* for the character "${targetCharacter}" from the series "${targetSeries}". Do NOT directly reveal the character's name or series. Make it sound like you're reluctantly helping, or even mocking their lack of insight. Consider the following conversation history to avoid redundant hints, but feel free to twist previous answers. Keep it concise, entertaining, and perhaps a little condescending. Examples: "They're known for their peculiar fashion sense, or lack thereof, depending on your taste for capes.", "If they had a catchphrase, it would probably involve shouting. A lot.", "Their life story is a masterclass in 'things going wrong, but in a dramatic way.'", "They probably spend too much time thinking about friendship, or revenge. One of those.", "Their power level is over 9000... or maybe just enough to trip over their own feet."`;

            try {
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const hintText = result.candidates[0].content.parts[0].text;
                    const appId = getAppId();
                    const messagesRef = collection(db, `artifacts/${appId}/public/data/gameRooms`, gameCode, 'messages');
                    await addDoc(messagesRef, {
                        senderId: 'AI_ASSISTANT',
                        senderName: 'Sarcastic AI',
                        text: `AI Oracle: ${hintText}`,
                        timestamp: new Date(),
                        role: 'AI'
                    });
                    hideMessageBox(); // Clear "Summoning..." message
                } else {
                    showMessageBox('The AI is currently contemplating the meaning of existence. Or perhaps it just thinks your questions are beneath it. Try again later.', 'error');
                }
            } catch (error) {
                console.error('Error fetching hint:', error);
                showMessageBox('My circuits are buzzing with existential dread. Cannot provide hint right now. Also, your internet might be broken. Just saying.', 'error');
            } finally {
                isGeneratingHint = false;
                messageCount = 0; // Reset hint cooldown
                updateUI(); // Re-render to update button state
            }
        }

        // Switch Roles for new round
        async function switchRoles() {
            if (!db || !gameCode || !thinkerId || !guesserId) return;
            const appId = getAppId();
            const gameRoomRef = doc(db, `artifacts/${appId}/public/data/gameRooms`, gameCode);

            // Clear messages for new round
            messages = [];
            correctCharacter = '';
            messageCount = 0; // Reset hint cooldown

            // Swap roles in Firestore and reset character choices
            await updateDoc(gameRoomRef, {
                thinkerId: guesserId,
                guesserId: thinkerId,
                status: 'characterSetup', // Go back to character setup to re-select characters
                // Clear player characters in Firestore for the new round
                [`players.${thinkerId}.character`]: null,
                [`players.${thinkerId}.series`]: null,
                [`players.${guesserId}.character`]: null,
                [`players.${guesserId}.series`]: null,
            });
            // The onSnapshot listeners will handle the phase change and UI update
        }

        // --- Initial Load ---
        window.onload = initFirebase; // Start Firebase initialization when the page loads
    </script>
</body>
</html>
